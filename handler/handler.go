package handler

import (
	"math/rand"
	"net/http"
	"net/url"
	"text/template"

	"simplemath/gen"
	"simplemath/operator"

	"github.com/labstack/echo/v4"
)

type Item struct {
	Emoji string
	Text  string
}

type SubmitHandler struct {
	rng *rand.Rand
}

type Result struct {
	Operator string
	Items    []Item
}

func NewSubmitHandler(r *rand.Rand) *SubmitHandler { return &SubmitHandler{rng: r} }

func (h *SubmitHandler) HandleSubmit(c echo.Context) error {
	form, err := FormDataFromRequest(c)
	if err != nil {
		c.SetCookie(&http.Cookie{
			Name:     "flash_error",
			Value:    url.QueryEscape(err.Error()),
			Path:     "/",
			MaxAge:   5,
			HttpOnly: false,
		})
		return c.Redirect(303, "/")
	}

	sym := operator.Operator(form.Operator).Symbol()
	seen := map[string]bool{}
	count, attempts, maxAttempts := 0, 0, form.NumQuestions*10

	var items []Item
	for count < form.NumQuestions && attempts < maxAttempts {
		ops := make([]int, form.NumOperands)
		for i := 0; i < form.NumOperands; i++ {
			ops[i] = gen.RandomWithDigits(h.rng, form.Digits[i])
		}
		problem := gen.JoinOperands(ops, sym)
		if !seen[problem] {
			seen[problem] = true
			items = append(items, Item{
				Emoji: getRandomEmoji(),
				Text:  problem,
			})
			count++
		}
		attempts++
	}

	// Load and execute the template.
	tpl, err := template.ParseFiles("statics/result.html")
	if err != nil {
		return err
	}
	_ = tpl.Execute(c.Response().Writer, Result{
		Operator: form.Operator,
		Items:    items,
	})
	return nil
}

// Get a random emoji from the emojis slice.
func getRandomEmoji() string {
	// Select a random index
	randomIndex := rand.Intn(len(emojis))
	// Return the emoji at the random index
	return emojis[randomIndex]
}

// Large slice of emojis covering the requested categories.
var emojis = []string{
	// Animals & Nature
	"ðŸµ", "ðŸ’", "ðŸ¦", "ðŸ¦§", "ðŸ¶", "ðŸ•", "ðŸ¦®", "ðŸ©", "ðŸº", "ðŸ¦Š",
	"ðŸ¦", "ðŸ±", "ðŸˆ", "ðŸ¦", "ðŸ¯", "ðŸ…", "ðŸ†", "ðŸ´", "ðŸŽ", "ðŸ¦Œ",
	"ðŸ®", "ðŸ‚", "ðŸƒ", "ðŸ„", "ðŸ·", "ðŸ–", "ðŸ—", "ðŸ½", "ðŸ", "ðŸ‘",
	"ðŸ", "ðŸª", "ðŸ«", "ðŸ¦™", "ðŸ¦’", "ðŸ˜", "ðŸ¦£", "ðŸ¦", "ðŸ¦›", "ðŸ­",
	"ðŸ", "ðŸ€", "ðŸ¹", "ðŸ°", "ðŸ‡", "ðŸ¿ï¸", "ðŸ¦«", "ðŸ¦¡", "ðŸ¦”", "ðŸ¦¦",
	"ðŸ¦‡", "ðŸ»", "ðŸ»â€â„ï¸", "ðŸ¨", "ðŸ¼", "ðŸ¦¥", "ðŸ¾", "ðŸ¦ƒ", "ðŸ”", "ðŸ“",
	"ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ§", "ðŸ•Šï¸", "ðŸ¦…", "ðŸ¦†", "ðŸ¦¢", "ðŸ¦‰",
	"ðŸ¦¤", "ðŸ¦©", "ðŸ¦œ", "ðŸ¸", "ðŸŠ", "ðŸ¢", "ðŸ¦Ž", "ðŸ", "ðŸ²", "ðŸ‰",
	"ðŸ¦•", "ðŸ¦–", "ðŸ³", "ðŸ‹", "ðŸ¬", "ðŸ¦­", "ðŸ ", "ðŸŸ", "ðŸ¡", "ðŸ¦ˆ",
	"ðŸ™", "ðŸš", "ðŸŒ", "ðŸ¦‹", "ðŸ›", "ðŸœ", "ðŸ", "ðŸª²", "ðŸž", "ðŸ¦—",
	"ðŸª³", "ðŸ•·ï¸", "ðŸ•¸ï¸", "ðŸ¦‚", "ðŸ¦Ÿ", "ðŸª°", "ðŸª±", "ðŸ¦ ", "ðŸ’", "ðŸŒ¸",
	"ðŸ’®", "ðŸª·", "ðŸª»", "ðŸŒ·", "ðŸŒ¹", "ðŸ¥€", "ðŸŒº", "ðŸŒ»", "ðŸŒ¼", "ðŸ‚",
	"ðŸ", "ðŸŒ¾", "ðŸŒ¿", "ðŸŒ±", "ðŸŒ²", "ðŸŒ³", "ðŸŒ´", "ðŸŒµ", "ðŸª´", "ðŸª¹",
	"ðŸªº", "ðŸŒ°", "ðŸ„", "ðŸŒŽ", "ðŸŒ", "ðŸŒ", "ðŸŒ‘", "ðŸŒ’", "ðŸŒ“", "ðŸŒ”",
	"ðŸŒ•", "ðŸŒ–", "ðŸŒ—", "ðŸŒ˜", "ðŸŒ™", "ðŸŒš", "ðŸŒ›", "ðŸŒœ", "ðŸŒ", "ðŸŒž",
	"ðŸŒŸ", "ðŸŒ ", "ðŸŒŒ", "â˜„ï¸", "ðŸª", "â˜€ï¸", "ðŸŒ¡ï¸", "ðŸŒ¤ï¸", "ðŸŒ¥ï¸", "ðŸŒ¦ï¸",
	"â˜ï¸", "ðŸŒ§ï¸", "â›ˆï¸", "ðŸŒ©ï¸", "âš¡", "ðŸ”¥", "ðŸ’¥", "â„ï¸", "ðŸŒ¨ï¸", "â˜ƒï¸",
	"â›„", "ðŸŒ¬ï¸", "ðŸ’¨", "ðŸŒªï¸", "ðŸŒ«ï¸", "ðŸŒˆ", "â˜‚ï¸", "â˜”", "ðŸ’§", "ðŸŒŠ",
	"ðŸª¨", "ðŸªµ", "ðŸ”ï¸", "â›°ï¸", "ðŸŒ‹", "ðŸ—»", "ðŸ•ï¸", "ðŸžï¸", "ðŸ›£ï¸", "ðŸ›¤ï¸",
	"ðŸŒ…", "ðŸŒ„", "ðŸ™ï¸", "ðŸŒ‰", "ðŸŒƒ", "ðŸŒ†", "ðŸŒ‡",

	// Food & Drink
	"ðŸ‡", "ðŸˆ", "ðŸ‰", "ðŸŠ", "ðŸ‹", "ðŸŒ", "ðŸ", "ðŸ¥­", "ðŸŽ", "ðŸ",
	"ðŸ", "ðŸ‘", "ðŸ’", "ðŸ“", "ðŸ«", "ðŸ¥", "ðŸ…", "ðŸ«’", "ðŸ¥¥", "ðŸ¥‘",
	"ðŸ†", "ðŸ¥”", "ðŸ¥•", "ðŸŒ½", "ðŸŒ¶ï¸", "ðŸ«‘", "ðŸ¥’", "ðŸ¥¬", "ðŸ¥¦", "ðŸ§„",
	"ðŸ§…", "ðŸ¥œ", "ðŸŒ°", "ðŸ«š", "ðŸ«›", "ðŸ«˜", "ðŸž", "ðŸ¥", "ðŸ¥–", "ðŸ«“",
	"ðŸ¥¨", "ðŸ§€", "ðŸ¥š", "ðŸ³", "ðŸ§ˆ", "ðŸ¥“", "ðŸ¥©", "ðŸ—", "ðŸ–", "ðŸ¦´",
	"ðŸŒ­", "ðŸ”", "ðŸŸ", "ðŸ•", "ðŸ«”", "ðŸ¥ª", "ðŸ«•", "ðŸ¥™", "ðŸ§†", "ðŸŒ®",
	"ðŸŒ¯", "ðŸ«™", "ðŸ«›", "ðŸ", "ðŸœ", "ðŸ²", "ðŸ›", "ðŸ£", "ðŸ±", "ðŸ¥Ÿ",
	"ðŸ¦ª", "ðŸš", "ðŸ˜", "ðŸ™", "ðŸ¢", "ðŸ¡", "ðŸ§", "ðŸ¡", "ðŸ¨", "ðŸ¦",
	"ðŸ©", "ðŸª", "ðŸŽ‚", "ðŸ°", "ðŸ§", "ðŸ¥§", "ðŸ«", "ðŸ¬", "ðŸ­", "ðŸ®",
	"ðŸ¯", "ðŸ¶", "ðŸ¼", "ðŸ¥›", "â˜•", "ðŸµ", "ðŸ«–", "ðŸ§‹", "ðŸ¾", "ðŸ·",
	"ðŸ¸", "ðŸ¹", "ðŸ»", "ðŸ¥‚", "ðŸ¥ƒ", "ðŸ«—", "ðŸ¥¤", "ðŸ§Š", "ðŸ¥„", "ðŸ´",
	"ðŸ½ï¸", "ðŸ”ª", "ðŸ¥¢", "ðŸ§‚",

	// Travel & Places
	"ðŸš—", "ðŸš•", "ðŸš™", "ðŸšŒ", "ðŸšŽ", "ðŸŽï¸", "ðŸš“", "ðŸš‘", "ðŸš’", "ðŸš",
	"ðŸ›»", "ðŸšš", "ðŸš›", "ðŸšœ", "ðŸ›µ", "ðŸï¸", "ðŸ›º", "ðŸš²", "ðŸ›´", "ðŸ¦¼",
	"ðŸ¦½", "ðŸ©¼", "ðŸ›ž", "ðŸš¨", "ðŸš”", "ðŸš", "ðŸš–", "ðŸš¡", "ðŸš ", "ðŸšŸ",
	"ðŸšƒ", "ðŸš„", "ðŸš…", "ðŸš‚", "ðŸš†", "ðŸš‡", "ðŸšˆ", "ðŸš", "ðŸšŸ", "ðŸ›—",
	"âœˆï¸", "ðŸ›«", "ðŸ›¬", "ðŸš", "ðŸš€", "ðŸ›¸", "ðŸ›¶", "â›µ", "ðŸš¤", "ðŸ›¥ï¸",
	"ðŸ›³ï¸", "â›´ï¸", "ðŸš¢", "âš“", "ðŸš§", "ðŸš¦", "ðŸš¥", "â›½", "ðŸš", "ðŸ—ºï¸",
	"ðŸ—¾", "ðŸ§­", "ðŸ’’", "â›ª", "ðŸ•Œ", "ðŸ›•", "ðŸ•", "â›©ï¸", "ðŸ•‹", "ðŸ°",
	"ðŸ¯", "ðŸŸï¸", "ðŸ—¼", "ðŸ—½", "ðŸ ", "ðŸ¡", "ðŸ˜ï¸", "ðŸ›–", "ðŸšï¸", "ðŸ¢",
	"ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ¨", "ðŸ©", "ðŸª", "ðŸ«", "ðŸ­", "ðŸ¯",
	"ðŸ¯", "ðŸ°", "ðŸ—¼", "ðŸ—½", "ðŸ ", "ðŸ¡", "ðŸ˜ï¸", "ðŸšï¸", "ðŸ¢", "ðŸ£",
	"ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ¨", "ðŸ©", "ðŸª", "ðŸ«", "ðŸ­", "ðŸ¯", "ðŸ¯",
	"ðŸŒƒ", "ðŸŒ†", "ðŸŒ‡", "ðŸŒ‰", "ðŸ›•", "ðŸ•", "â›©ï¸", "ðŸ•‹", "ðŸ›ï¸", "ðŸ›–",
	"ðŸžï¸", "ðŸ›£ï¸", "ðŸ›¤ï¸", "ðŸŒ…", "ðŸŒ„", "ðŸ™ï¸", "ðŸŒ‰", "ðŸŒƒ", "ðŸŒ†", "ðŸŒ‡",
}
